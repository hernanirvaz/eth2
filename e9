#!/bin/bash
# */2 1,9,17 * * * e9

[[ -d $HOME                   ]] || exit 1
[[ -x $(command -v speedtest) ]] || exit 1

DNL='/dev/null'
FIL="$HOME/e9"

if [[ -s $FIL.lck ]];then
    if ps -p $(cat $FIL.lck) > $DNL 2>&1;then
        exit 1
    else
        rm -f $FIL.lck
    fi
fi
echo $$ > $FIL.lck;trap "rm -f $FIL.lck" EXIT   

st0 () { speedtest --simple | grep -Ei 'Ping|Download|Upload'; }
stc () { local o;o=$(st0 2>$DNL);if [[ "$o" ]];then echo $(date +"%Y-%m-%d %H:%M:%S") $o   ;fi; }
sto () { local e;e=$(stc 2>$DNL);if [[ "$e" ]];then echo $e >> $FIL.log;[[ $1 ]] && echo $e;fi; }

if [[ $1 ]];then
    sto $1
else
    mc=$(date +%-M);nr=$(date +%s%N);mr=$(awk -v m=0 -v x=59 -v s="$nr" "BEGIN{srand(s);print int(m+rand()*(x-m+1))}")
    if [[ "$mc" = "$mr" ]];then sto;fi
fi
