#!/bin/bash
# */2 1,9,17 * * * e9

[[ -d $HOME                   ]] || exit 1
[[ -x $(command -v speedtest) ]] || exit 1

DNL='/dev/null'
FIL="$HOME/e9"

if [[ -f $FIL.lck ]];then
    if ps -p $(cat $FIL.lck) > $DNL 2>&1;then
        exit 1
    else
        rm -f $FIL.lck
    fi
fi
echo $$ > $FIL.lck;trap "rm -f $FIL.lck" EXIT   

stc () { local e;e=$(speedtest --simple 2>$DNL | grep -Ei 'Ping|Download|Upload' 2>$DNL);[[ "$e" ]] || return;echo $(date +"%Y-%m-%d %H:%M:%S" 2>$DNL) $e; }

if [[ $1 ]];then
    stc
else
    mc=$(date +%M 2>$DNL);nr=$(date +%s%N 2>$DNL);mr=$(awk -v m=0 -v x=59 -v s="$nr" "BEGIN{srand(s);print int(m+rand()*(x-m+1))}" 2>$DNL)
    if [[ "$mc" -eq "$mr" ]];then stc >> $FIL.log 2>$DNL;fi
fi
