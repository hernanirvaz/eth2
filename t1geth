#!/bin/bash

i="\n\e[5m"
f="\e[25m\n"

echo -e "${i}CRIA ALIAS${f}"

# beacon external/internal eth1
bn="beacon.service"
bs="/etc/systemd/system/$bn"
ee="https:\S* "
ei="http:\S*8545 "
sr="http://127.0.0.1:8545"
c1="sudo systemctl stop beacon"
c1="$c1;cp $bs $bn.save"
c1="$c1;if grep -q \"$ee\" $bn.save;then sed -e \"s%$ee%http://127.0.0.1:8545 %\" $bn.save > $bs;else sed -e \"s%$ei%$E %\" $bn.save > $bs;fi"
c1="$c1;sudo systemctl daemon-reload"
c1="$c1;sudo systemctl start beacon"
# ajuda
c2="echo -e \""
c2="$c2\nus\tupdate system"
c2="$c2\ndr\tdaemon-reload"
c2="$c2\n"
c2="$c2\nfs\tfirewall status"
c2="$c2\nfa\tfirewall arranca"
c2="$c2\n"
c2="$c2\njj\tjournal total"
c2="$c2\njg\tjournal geth"
c2="$c2\njb\tjournal beacon"
c2="$c2\njv\tjournal validator"
c2="$c2\njf\tjournal grafana"
c2="$c2\njn\tjournal node"
c2="$c2\njp\tjournal prometheus"
c2="$c2\n"
c2="$c2\nga\tgeth arranca"
c2="$c2\nva\tvalidator arranca"
c2="$c2\nba\tbeacon arranca"
c2="$c2\ngr\tgeth restart"
c2="$c2\nvr\tvalidator restart"
c2="$c2\nbr\tbeacon restart"
c2="$c2\nbx\tbeacon external/internal eth1"
c2="$c2\nta\ttudo arranca"
c2="$c2\nte\ttudo enable"
c2="$c2\n"
c2="$c2\nfpr\tfirewall para"
c2="$c2\ngpr\tgeth para"
c2="$c2\nbpr\tbeacon para"
c2="$c2\nvpr\tvalidator para"
c2="$c2\ntpr\ttudo para"
c2="$c2\ntds\ttudo disable"
c2="$c2\n\""
# arranca tudo
c3="sudo systemctl daemon-reload"
c3="$c3;sudo systemctl start geth"
c3="$c3;sudo systemctl start beacon"
c3="$c3;sudo systemctl start validator"
c3="$c3;sudo systemctl start prometheus"
c3="$c3;sudo systemctl start node"
c3="$c3;sudo systemctl start grafana-server"
# enable tudo
c4="sudo systemctl daemon-reload"
c4="$c4;sudo systemctl enable geth"
c4="$c4;sudo systemctl enable beacon"
c4="$c4;sudo systemctl enable validator"
c4="$c4;sudo systemctl enable prometheus"
c4="$c4;sudo systemctl enable node"
c4="$c4;sudo systemctl enable grafana-server"
# para tudo
c5="sudo systemctl stop grafana-server"
c5="$c5;sudo systemctl stop node"
c5="$c5;sudo systemctl stop prometheus"
c5="$c5;sudo systemctl stop validator"
c5="$c5;sudo systemctl stop beacon"
c5="$c5;sudo systemctl stop geth"
# disable tudo
c6="sudo systemctl disable grafana-server"
c6="$c6;sudo systemctl disable node"
c6="$c6;sudo systemctl disable prometheus"
c6="$c6;sudo systemctl disable validator"
c6="$c6;sudo systemctl disable beacon"
c6="$c6;sudo systemctl disable geth"

cat <<-EOF > ~/.bash_aliases
alias ajuda='$c2'
alias us='echo -e "${i}FULL-UPGRADE${f}";sudo apt update && sudo apt full-upgrade;echo -e "${i}DIST-UPGRADE${f}";sudo apt dist-upgrade && sudo apt autoremove'
alias dr='sudo systemctl daemon-reload'

alias fs='sudo ufw status numbered'
alias fa='sudo ufw enable'

alias jj='sudo journalctl -f'
alias jg='sudo journalctl -f -u geth.service'
alias jb='sudo journalctl -f -u beacon.service'
alias jv='sudo journalctl -f -u validator.service'
alias jf='sudo journalctl -f -u grafana-server.service'
alias jn='sudo journalctl -f -u node.service'
alias jp='sudo journalctl -f -u prometheus.service'

alias ga='sudo systemctl daemon-reload;sudo systemctl start geth'
alias va='sudo systemctl daemon-reload;sudo systemctl start validator'
alias ba='sudo systemctl daemon-reload;sudo systemctl start beacon'
alias gr='sudo systemctl daemon-reload;sudo systemctl restart geth'
alias vr='sudo systemctl daemon-reload;sudo systemctl restart validator'
alias br='sudo systemctl daemon-reload;sudo systemctl restart beacon'
alias bx='$c1'
alias ta='$c3'
alias te='$c4'

alias fpr='sudo ufw disable'
alias gpr='sudo systemctl stop geth'
alias bpr='sudo systemctl stop beacon'
alias vpr='sudo systemctl stop validator'
alias tpr='$c5'
alias tds='$c6'
EOF

if [ "$(sudo ufw status|grep -i inactive)" ]; then

  echo -e "${i}FIREWALL${f}"
  sudo ufw deny 22/tcp comment 'Acesso remoto (old)'
  sudo ufw deny 30303 comment 'eth1 peers'
  sudo ufw deny 9000 comment 'Lighthouse'
  sudo ufw deny 9090/tcp comment 'Prometheus'
  sudo ufw deny 3000/tcp comment 'Grafana'
  sudo ufw allow 2020/tcp comment 'Acesso remoto (new)'
  sudo ufw allow 123/udp comment 'Timekeeping'
  sudo ufw enable
  sudo ufw status numbered

  echo -e "${i}ROOTKIT SCANNER${f}"
  sudo apt install -y chkrootkit
  sudo chkrootkit  -q

  echo -e "${i}TIMEKEEPING (NTP)${f}"
  sudo apt install -y ntp
  sudo timedatectl set-ntp no
  timedatectl
  ntpq -p

else

  echo -e "${i}FIREWALL $(sudo ufw status|grep -i status|tr '[:lower:]' '[:upper:]')${f}"

fi 

if [ -f /etc/systemd/system/geth.service ]; then

  echo -e "${i}GETH NODE JA INSTALADO${f}"

else

  user="eth1"
  blkc="--mainnet"
  node=''
  blkc="--goerli"
  node='--bootnodes "enode://a1e8102e7beb94207c8608d7e2615579cf34200c15e24fd797b178f42d05d2e9d9a89c73577d1f9f4070360df20a14014c242674f7731421b188f0bf4618480a@176.144.82.166:30303,enode://46add44b9f13965f7b9875ac6b85f016f341012d84f975377573800a863526f4da19ae2c620ec73d11591fa9510e992ecc03ad0751f53cc02f7c7ed6d55c7291@94.237.54.114:30313,enode://6010c16d5776036f0f96a526aa17e302b91b0c955b9edbbcde924d7e35e9b0646333b192dc1c18cf4c217ed4ba76632548a62daf6536d661637efa437c6d62d8@54.198.42.106:30303,enode://290955521ff90413b3d6a842e830f9a9ab468fd27058534ed410cef816beb57ec5d965f8fd74a5ac52c43c6277a6a47add4eff06b4f4bfdf1d597006b8b5b764@83.162.151.227:30303,enode://9d8eeb510d16515a9f8c3f542047d3cec3d4d19a2d2d3881fca1cabaabc99aad4b30e9339815f0fb57ee1b6c0bd54abf2033006145713c6f2b91ddb285a55757@78.46.136.255:30303,enode://a12c8f94d85b96c73fa9efdbbe1f7625907c3cdffac1f37eb50f995bce93f48a81200e8292e87660230c9390d712bf9c59deee4b69ef4c81017ac2f6562307e5@94.236.246.163:30303,enode://5eb99255b9e267d7bcaa95620218de6fdbcead7a61059796ec7bcd05451e0e9ab2511f7cfe5cd7e3e4d76b15b45367406a7dda2c720e9ea58161776df33704ee@104.163.209.53:30303,enode://2c3cc8872f6dabd0c80ae12a09d33ff957b2e5eae008166e36d64f16902b6d7adaf1303ea1e0c3d9305ca3716fae69c0eb59abf198b751b43faa01a008ff9d26@86.218.77.141:30303,enode://215813e4cbeea8c8a4241095cfa364b0e22996ef7aa44902a60a24569221376f2ec7980c7e8e7960bc395c2182c5d7e8762b1596863a8826c0b38785a11d3e38@49.12.106.203:30303,enode://ea35efec88e7c8f34a120b17b7358e4d2fcb6ca052bfd5a5c61ab5284a782224f32cb1c9e1768c8fe4b0e19c9fd610ff7b3b79f95cd9f7bf4b1a68eb39bf5909@5.252.226.187:30303,enode://27eb8bb162ee019410618b1b7430b3b3e13eb59e04fb148a01e0d7b9ca5b2808d9a3504623ad687c622ae2c7c63054b50abae5e9688822bdeefe6163525f611e@54.225.105.43:30303,enode://a61215641fb8714a373c80edbfa0ea8878243193f57c96eeb44d0bc019ef295abd4e044fd619bfc4c59731a73fb79afe84e9ab6da0c743ceb479cbb6d263fa91@3.11.147.67:30303,enode://f4471165eb8219564c1432d39ebee3ade2e70ebdbb1ea681260b2558eacfc7ca9c88b71f57571ddddf756790dc6db805a3645e43aa41ea52b258a61610201a76@89.142.71.16:30303,enode://10d35746b4fe0624efbaa08afb7ece9e30793484c3c682e069e921d74eb8eb7146fbd927d2ce278c384278c1bdeabb316e11c9881fa3c64638f1375360880591@47.90.59.177:30303,enode://6c8e48bcf1f2194b6625bcc066afe62593f0f78e1fc355698459733dcc562500396c7484e25d7cc80a796db186947436c9b3518c2f998dfe0d0c59284b08a3c2@144.76.236.199:40303,enode://a33926b9ace21b30ecba325d05fad62144cb2f0d825f7c184b669cb41b3802c95e9878fff8a9cbc79317a67cfde6a07eeb47d3fda1b779d0dbca02a45205ea23@203.192.211.202:30303"'
  golb="/var/lib/goethereum"

  echo -e "${i}INSTALL GETH NODE${f}"

  sudo apt-get install -y software-properties-common
  sudo apt-get update
  sudo add-apt-repository -y ppa:ethereum/ethereum
  sudo apt update
  sudo apt install -y geth
  sudo useradd --no-create-home --shell /bin/false $user
  sudo mkdir -p $golb
  sudo chown -R $user:$user $golb
  cat <<-EOF > geth.service
  [Unit]
  Description=Ethereum go client
  After=network.target
  Wants=network.target

  [Service]
  User=$user
  Group=$user
  Type=simple
  Restart=always
  RestartSec=5
  ExecStart=geth $blkc --http --datadir $golb $node

  [Install]
  WantedBy=default.target
EOF
  sudo mv geth.service /etc/systemd/system/geth.service
  sudo ufw allow 30303 comment 'eth1 peers'
  sudo ufw reload
  sudo systemctl daemon-reload
  sudo systemctl restart geth
  sudo systemctl enable geth

fi

echo -e "${i}FAZER SEMPRE LOGOUT PODE TER NOVOS ALIAS${f}"
