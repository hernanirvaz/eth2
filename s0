#!/bin/bash

ip=$(hostname -I);ip=${ip%% *};if [[ $ip = 192.168.8.* ]];then iu=eu;else iu=ubuntu;echo -e "\nvip1='$ip';vnd1='$(hostname).$(hostname -d)'\n\e[5mALTERAR\e[25m ~/eth2/a0\n";fi
source /home/$iu/i0

sc='/etc/ssh/sshd_config'
ss='/lib/systemd/system/ssh.socket'
m1='/etc/msmtprc'
m2='/etc/aliases'
un=eth
sh=ssh
uh="/home/$un"
s1="s%^ *#* *Port *22 *$%Port $pr%i"
s1="$s1;s%^ *#* *PermitRootLogin  *.*$%PermitRootLogin no%i"
s1="$s1;s%^ *#* *PasswordAuthentication  *.*$%PasswordAuthentication no%i"
s1="$s1;s%^ *#* *PermitEmptyPasswords  *.*$%PermitEmptyPasswords no%i"
s1="$s1;s%^ *#* *KbdInteractiveAuthentication  *.*$%KbdInteractiveAuthentication no%i"
s1="$s1;s%^ *#* *UsePAM  *.*$%UsePAM no%i"
s2='defaults' # treats from: msmtp config
s2="$s2\nauth on"
s2="$s2\ntls on"
s2="$s2\ntls_trust_file /etc/ssl/certs/ca-certificates.crt"
s2="$s2\nsyslog on"
s2="$s2\naliases /etc/aliases"
s2="$s2\nauto_from on"
s2="$s2\nmaildomain fruga.pt"
s2="$s2\naccount smtp2go"
s2="$s2\nhost mail.smtp2go.com"
s2="$s2\nport 587"
s2="$s2\nuser fruga.pt"
s2="$s2\npassword $V$E"
s2="$s2\naccount default : smtp2go"
s3='default: hernanilr@gmail.com' # treats to: aliases config
s4="s%^ *ListenStream *=(.*):[0-9]+$%ListenStream=\1:$pr%i"

function sse { local f=$(basename $1);[[ -s $1 ]] && cp $1 $f.sav;sed -E "$2" $f.sav > $1;cp $1 $f.new;chmod $3 $1;chown $4 $1; }
function ssa { local f=$(basename $1);[[ -s $1 ]] && cp $1 $f.sav;echo -e "$2"       > $1;cp $1 $f.new;chmod $3 $1;chown $4 $1; }
function ssp { echo -e "\n\e[5mchange passwd\e[25m ${2:-root}:\t$1\n";echo -e "$1\n$1"|passwd $2; }

echo -e "\napt update"
apt update -y                               &>> apt.out
apt full-upgrade -y                         &>> apt.out
apt dist-upgrade -y                         &>> apt.out
apt autoremove                              &>> apt.out
apt autoclean                               &>> apt.out
apt install msmtp msmtp-mta bsd-mailx jq -y &>> apt.out
sse $sc "$s1" 644 root:root;if [[ ${ip%%.*} -ne 192 ]];then sse $ss "$s4" 644 root:root;ssp $V $iu;fi;systemctl daemon-reload;systemctl reload $sh;systemctl restart $sh
ssa $m1 "$s2" 644 root:root;ssa $m2 "$s3" 644 root:root
adduser --disabled-password --comment "" $un
ssp $H $un
usermod -aG sudo $un
mkdir -p $uh/.ssh $uh/${un}2
mv /home/$iu/keth $uh/.ssh/authorized_keys
chown -R $un:$un $uh/.ssh $uh/${un}2
chmod 700 $uh/.ssh
chmod 600 $uh/.ssh/authorized_keys
ssp $R
