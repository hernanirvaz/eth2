#!/bin/bash

source /home/eth/eth2/t1

function hlp { swn "\n\ninstall consencus client with lighthouse-${1:-stable} source using rust-${2:-stable}\n"; }

if [[ $cunm = $znm4 || $cunm = $znm2 || $cunm = $vnm1 ]];then
  hlp
  if [[ -x ${p[9]}/.cargo/bin/rustup ]];then
    t6 ruv $2                                                                                                                                                 # rust update
  else
    swu 'BASE NEEDS';cex 'apt install curl build-essential libssl-dev libudev-dev perl yasm -y'                                                               # base dependencies
    swu 'RUST NEEDS';cex 'apt install git gcc g++ make cmake pkg-config llvm-dev libclang-dev clang protobuf-compiler -y'                                     # rust dependencies

    swu 'RUST INSTALL';cd ${p[9]};curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh;source "$HOME/.cargo/env"                                    # rust install
  fi
  [[ -f ${p[9]}/.cargo/bin/lighthouse ]] || t6 luc $1                                                                                                         # cc compile
fi
t6 lpi                                                                                                                                                        # cc propagate/install
if [[ $cunm = $znm1 || -f $(pjp 4 71).service ]];then                                                                                                         # cc not here
  if [[ -f $(pjp 4 71).service ]];then swu "cc ja instalado";else swu 'cc NAO DEVE SER INSTALADO AQUI';fi
else
  # slots per restore point after init can't be changed
  sprp=1024 # Yearly Disk Usage  12.8GB
  sprp=512  # Yearly Disk Usage  25.6GB
  sprp=256  # Yearly Disk Usage  51.2GB
  sprp=128  # Yearly Disk Usage 102.4GB
  sprp=2048 # Yearly Disk Usage   6.4GB default use disk space for slasher (256GB) -> more income
  # how many peers it should try to find and maintain
  tarp=20 # less bandwidth/load for gossip - too low (<20) and block proposals start getting orphaned or even missed
  tarp=50 # default
  http=''                          # default
  http=' --http-address 127.0.0.1' # equivalent empty
  [[ $cunm = $znm2 ]] && http=" --http-address $zip2"
  [[ $cunm = $znm3 ]] && http=" --http-address $zip3"
  [[ $cunm = $znm4 ]] && http=" --http-address $zip4"
  [[ $cunm = $vnm1 ]] && http=" --http-address $vip1"
  epec=" --eth1-endpoints http://$zip1:8545,https://eth-mainnet.alchemyapi.io/v2/vzq1DD3EX7ipGuKck4440uRuccDdVvTm,https://mainnet.infura.io/v3/65be3572c577449f86d92b2e69cd6b06,https://mainnet.infura.io/v3/2c680650de0443cf8ab433565e47a42d"
  epec=" --eth1-endpoints http://$zip4:8545,http://$zip1:8545"
  epec=" --execution-endpoint http://$zip1:8551 --execution-jwt ${p[16]}/jwt"                                                                                 # MERGE
  epec="$epec --suggested-fee-recipient ${p[99]}"                                                                                                             # cc level fees
  othe=''
  othe="$othe --subscribe-all-subnets --import-all-attestations"                                                                                              # 5% more profitable
  othe="$othe --validator-monitor-file ${p[16]}/pubkeys"                                                                                                      # monitor validators
  if [[ $cust = hrv ]];then                                                                                                                                   # syncing from finalized checkpoint
    othe="$othe --checkpoint-sync-url http://192.168.8.34:5052"
  else
    othe="$othe --checkpoint-sync-url https://1q1s6o6cB6Jysu7KKlbLUYiOdAM:8974468780164028652df958a69fbd30@eth2-beacon-mainnet.infura.io"
  fi
  othe="$othe --prune-payloads true"                                                                                                                          # fetch/keep execution payloads default true
  othe="$othe --builder http://192.168.8.28:18550"                                                                                                            # external payload mev-boost
  othe="$othe --builder-profit-threshold 20000000000000000"                                                                                                   # external payload only if reward >= 0.02 ETH
  othe="$othe --disable-upnp"
  # othe="$othe --slasher"
  # othe="$othe --monitoring-endpoint https://beaconcha.in/api/v1/client/metrics?apikey=$B&machine=$(snc $cunm)"                                              # monitor data for beaconcha.in app
  swu 'CONFIGURE BEACON';sex "mkdir -p ${p[16]}";cmw ${p[10]} 755 $meeu;sau eth2
  pjv $(seq 200 221) > ${p[10]}/pubkeys;sex "mv ${p[10]}/pubkeys ${p[16]}";cmw ${p[16]}/pubkeys 600 eth2
  cmw ${p[16]} 700 eth2;touch ${p[10]}/vc_lock;cd ${p[9]}                                                                                                     # IMPORTANTE LOCK vc
  pp2p=9000                                                                                                                                                   # default
  cat <<-EOF > ${p[71]}.service
	[Unit]
	Description=beacon service
	Wants=network-online.target
	After=network-online.target
	
	[Service]
	User=eth2
	Group=eth2
	Restart=always
	RestartSec=10
	ExecStart=${p[0]}/lighthouse --datadir ${p[10]} bn --port $pp2p --target-peers $tarp$http --staking$epec$othe
	ExecStopPost=${p[9]}/eth2/t8mail BEACSTP \$SERVICE_RESULT \$EXIT_CODE \$EXIT_STATUS
	
	[Install]
	WantedBy=multi-user.target
	EOF
  sex "mv ${p[71]}.service $(pjp 4 71).service";cmw $(pjp 4 71).service 644
  if [[ -f jwt ]];then sjw eth2 ${p[16]};else swb "needs ${p[16]}/jwt secret";fi
fi
if [[ $cunm != $cuvc || $cunm != $nxvc || -f ${p[10]}/vc_lock || -f $(pjp 4 73).service ]];then                                                                                         # vc not here
  if [[ -f $(pjp 4 73).service ]];then swu "vc ja instalado";else swu 'vc NAO PODE SER INSTALADO AQUI';fi
else
  # external beacon-node before MERGE
  # https://1q1s6o6cB6Jysu7KKlbLUYiOdAM:8974468780164028652df958a69fbd30@eth2-beacon-mainnet.infura.io
  if [[ $cust = hrv ]];then                                                                                                                                   # cc order
    epcc=" --beacon-nodes http://$zip4:5052,http://$zip3:5052"
  else
    epcc=" --beacon-nodes http://$vip1:5052"
  fi
  othe=''
  othe="$othe --suggested-fee-recipient ${p[99]}"                                                                                                             # vc level fees
  othe="$othe --disable-run-on-all"                                                                                                                           # no subscription/preparation messages
  # othe="$othe --monitoring-endpoint https://beaconcha.in/api/v1/client/metrics?apikey=$B&machine=$(snc $cunm)"                                              # monitor data for beaconcha.in app
  # othe="$othe --builder-proposals"                                                                                                                          # mev-boost
  sau eth3;cd ${p[9]}
  if [[ ! -f ${p[10]}/vc_keys && -d ${p[84]} && $(ls -A ${p[84]} 2>${p[3]}) ]];then
    swu 'IMPORT KEYS';sex "mkdir -p ${p[10]}";cmw ${p[10]} 755 $meeu
    swn "STORE($K)\n";lighthouse --datadir ${p[10]} account validator import --directory ${p[84]}                                                             # import keys
    [[ -f ${p[17]}/validator_definitions.yml ]] && touch ${p[10]}/vc_keys                                                                                     # check work
  fi
  if [[ ! -f ${p[10]}/vc_lock && -f ${p[10]}/vc_keys                           ]];then swn "\nDISABLE VC ->\t$cuvc";touch ${p[10]}/vc_lock;fi                 # vc so pode correr num servidor
  if [[   -f ${p[10]}/vc_lock && -f ${p[10]}/vc_keys && ! -f ${p[10]}/vc_slash ]];then
    sex "mkdir -p ${p[17]}";cmw ${p[17]} 755 $meeu;sis ${p[9]}/$(basename ${p[31]});sex "chown -R eth3:eth3 ${p[17]}";cmw ${p[17]} 700 eth3
  fi
  if [[ -f ${p[10]}/vc_slash && -f ${p[10]}/vc_lock && -f ${p[10]}/vc_keys ]];then
    swu 'vc CONFIG'
    cat <<-EOF > ${p[73]}.service
		[Unit]
		Description=validator service
		Wants=network-online.target
		After=network-online.target
		
		[Service]
		User=eth3
		Group=eth3
		Restart=always
		RestartSec=10
		ExecStart=${p[0]}/lighthouse --datadir ${p[10]} vc$epcc$othe
		ExecStopPost=${p[9]}/eth2/t8mail VALISTP \$SERVICE_RESULT \$EXIT_CODE \$EXIT_STATUS
		
		[Install]
		WantedBy=multi-user.target
		EOF
    sex "mv ${p[73]}.service $(pjp 4 73).service";cmw $(pjp 4 73).service 644
    swb 'VC CONFIGURADO VERIFICAR TUDO (LOCK & SLASH DB)'
  fi
fi
