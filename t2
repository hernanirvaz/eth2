#!/bin/bash

source /home/eth/eth2/t1

# cria link para tarefas
[ -x ~/eth2/t ] || ln -s ~/eth2/t6 ~/eth2/t

if [ "$(echo $H|sudo -S ufw status 2>/dev/null|grep -i inactive)" ]; then
  echo -e "${i}INIT FIREWALL${f}"
  sudo ufw default deny incoming
  sudo ufw default allow outgoing
  sudo ufw deny 22/tcp comment oldssh
  sudo ufw deny 30303 comment eth1
  sudo ufw deny 9000 comment eth2
  sudo ufw deny 8545 comment geapi
  sudo ufw deny 5052 comment bnapi
  sudo ufw deny 5064 comment vcmet
  sudo ufw deny 9090/tcp comment prometheus
  sudo ufw deny 3000/tcp comment grafana
  sudo ufw allow 2020/tcp comment newssh
  sudo ufw enable
  sudo ufw status numbered
  echo -e "${i}ROOTKIT SCANNER${f}"
  sudo apt install -y chkrootkit
  sudo chkrootkit  -q
  echo -e "${i}TIMEKEEPING (NTP)${f}"
  sudo timedatectl set-ntp on
  timedatectl
else
  echo -e "${i}FIREWALL $(echo $H|sudo -S ufw status 2>/dev/null|grep -i status|tr '[:lower:]' '[:upper:]')${f}"
fi 

t4update linux
# Install unattended upgrades
sudo apt install unattended-upgrades apt-listchanges -y
# Turn on unattended security updates, run
sudo dpkg-reconfigure -plow unattended-upgrades
# alert email
sed -e 's%^ */* *Unattended-Upgrade::Mail .*$%Unattended-Upgrade::Mail "hernanilr@gmail.com";%i' /etc/apt/apt.conf.d/50unattended-upgrades > ~/t1-upg.save
sudo mv ~/t1-upg.save /etc/apt/apt.conf.d/50unattended-upgrades
# install internet speed test
sudo apt install python3-pip -y
sudo pip3 install speedtest-cli
speedtest-cli

if [ "$bnip" != "$vcip" ] && ([ "$cuip" = "$vcip" ] || [ "$cuip" = "$vpsm" ]); then
  echo -e "${i}GETH NAO DEVE SER INSTALADO AQUI - DEVE FAZER REBOOT${f}"
else
  if [ -f /etc/systemd/system/$ethg.service ]; then
    echo -e "${i}GETH JA INSTALADO${f}"
  else
    echo -e "${i}INSTALAR GETH${f}"
    user="eth1"
    if [ "$B" = "mainnet" ]; then
      blkc=""
      cach=1024 # default
      maxp=30
      node='--bootnodes "enode://372cc9da5d91b0cf19c8773f3197ba98059041a709ca36d643d37942d9457d34eaee58f90d23bf3e20a7b777a2c4b9247e1aa301f493b2de5d53b3ddb5cb7ac7@116.202.210.165:57840,enode://88897be3c4a05b94813f69a8802d988cedaff711c9238811a0a38649b88703668686b4aee13ad066409a95a5368100528adf4fa7a0af7efd2a9ea194711a4da1@193.26.156.253:34896,enode://357d1b6c71fd1a9669a0d20aae53d18b69676a0eb2baa2209806932e7e1f1e20d154a823b1e200cb8434e17dcf837c4772f2231136b0164ccaaeeabf009dc2e0@119.8.107.226:16861,enode://3a98d3f88d7b4bf0d7251e6de7e43ae803a5ec260c35e02b526681af4d8b2e660dc3d10e64235a1551f35fa18de91cd22f5ed2c364a3e683b442f3a352bedd50@47.24.140.226:30303,enode://c9cd1b2514fc616abf0a1504e858235438ae0c3bd8d8af562e522eb5e9df703dbc516cd499232a230c107e611ec052a1860cbd3be2636ac4fb24715392c952cd@87.117.249.243:30303,enode://f303f44626b5989f240145086a35c2a94f46d923a9590d847814c703a44940b4367a9098e8b02cbc204d9798bbf6c3dfa04b8224870170be2a9d9a5d62e29e83@162.0.208.50:30303,enode://8ccae3f500b27cb533a1341ce6abd650b2e53ba14974985bbaec9e5a2f1b441676a1a95c145fc61fdc99d5013d3eb463a55177b412fee484b40bf84f22d24b1f@175.137.124.184:30303,enode://ad7c0d654582c70014d985da554985e4ea0d35b18503e209d3128503f98928d837b7a2b48dcbb11647feb69a347bbd065295561c6a81c49942497bf936fd15b4@95.217.207.214:30303,enode://64a8ed4a508fcbfa091b1587d864b96d61009e30a5e8c85fbd17173947f3bf0c30ddacffd2c80a9b3a1a33c25ae4ec137ac23e36836236adc4f0eb08863e0e04@3.113.0.101:35454,enode://f816b8161d4c8a1fb2fffe1dca2e56fa199a522f489726f9a7bcbd2c1962672c822f14c05f150b5325876513991b4fb36555e47c707818b702e0b57e73746333@168.119.37.29:30303,enode://2b8d85b9c25b1391e7731a4f8b729f0dea4c8f8d6b8333a9414a7b7ce59f2dd2f3c552f961f056e27e33efaf450d3ab3b08f9894f24ddd6efca81cd4a54a6906@161.97.109.8:38502,enode://c388c8f7242c1af910c36f3dc560afd61ee93148bb4bb38890e8b83392ac8a563a478da6f0462cac09b22e21c8f35e0385a8c10ed5b76fcb20427d09843eb854@54.81.103.91:30303,enode://10471d5573d9e96ec1c735a3786b72f84092b1e5c547fe1c47105a00984825648825fd36c47a49ea44c79bd8ec1774d20ca24569011dae9f4fbad2a11bc95653@54.254.25.74:47788,enode://1ee98d47a74603009809b276dc8027efa65d665617a367666d5417363f321c2445fab85789adb0cc39e57b88e970ee2e032df3a29b4f196c6ab68f66d1e27871@35.240.183.206:49870,enode://6b367694c2d2f418e1478f949ff527a0f8b1c2389638b809932ab6fb2ae0c0adf9f7744c5da1946664615f630e052b4be517f647ffdda2e976d246bd27ff2291@47.253.40.80:52282,enode://da5c8bc297402ac35144fe328781e8d222c8494b6d96c6d70bc0bc3078588d3e2d393e75be883535deb3ac9ed29707ce17a4839363a78b469fb91458d868cc51@18.223.28.179:11183,enode://6d98a6ffba8b082a4cd98808acbe39d49a2c215fc417455d66965bc1c661af0b7dafd6b6df43b206a2af3eb7bbf69f2d2f510ee345fff39e0878a73a2802c6b0@5.189.186.48:36494,enode://41bedf2d6d35b36880e0232f551f01a42a2da528255179f879e8e3e12c772db6d976687165183e4ef5c3882a9ceeb1672a3a9c965ffddec1851b8ffc711ff176@109.145.101.124:40982,enode://0927be422374ad0c0b8ad5712ba85ead4ea1537ebf378f78deb14eb3b8f4a750786329419bfef7fcc5aa34fc64d6553c1cad1c6bccd7985b6a14b23f5bfd94fa@180.215.227.139:30303,enode://d145af809ba6c652e7f1d7a5d6e32da1f0ec3f0bf28e6e646e3c2a718e5908c38219d3d7c267320adb5dfaeb9fa7bd9150154ee9344b5b755bf14b63b3af0aaf@92.38.148.32:30303,enode://3ce7e1e69ea541eec9d51b7fd2dc833704be615d0bfb69d7a59ace0e0c7bdadfce3c684c6e242f9bd784f2dd0d7181e832c8648bc3a6309444ffe2b769e70c22@108.245.189.120:60230,enode://fe20dbedc2e5b3e3e642869a67abffb47ae58a0b1da9f556c7f2afbb00dff587f2fd32e8667e25bb03530417a2e0e63715ce7ae38e0b69e81e33473db525acb6@95.217.228.180:44442,enode://4d51a054cc0c8c4104c9185f2b9563f3c78cabee7ad74a139f4ca6d4f0f3f42d2a172e5bc45a45a478d8a005ddeb365898734eb1b2b8c3ae29c93b558ebd67e7@34.214.203.97:30303,enode://3cf9d6d91c65705733411d338f1bb87cb6084befd71e5e5a32e5ee0b8f40f486ad57640061f006faf73821489f5188f6390adb17b12201e426e0ac853326abd8@161.97.133.248:30303,enode://de029aeef7357a46b9084d0295e78e3875ab618a5df9b9d715ad936d3a03344c3f4b4166fdfe74bf1d2240761adac204a545496a9762b255c4968552fe2cb703@103.214.68.147:44596,enode://16111cc3d55b44e2d88c5129eb8d04a10c8b25876af951648cee0a6f28a6840800ba547e6d9c13ecc7fc4bf1763ab85208b6d4ca84039fa527db8a4e46ebbf79@81.91.189.51:30303,enode://e31a4205c6e27f7d50b3ea441aeae27b92884d43e4b26fc72060c6745b43f3a46f2064da5a44f68259dc9f40393e8ce57c11283bb310b704d5709e48b0d798f5@13.57.239.130:54338,enode://583076a1939f96c75c2dcd1d1f95c05634e5981db6a0ffff4858dc5dba433fdd8a213fac12d9ed1b508226afd79ce5c66bb221744f0aff9c73010e7d48c2b0d6@80.72.128.84:30303,enode://b22f27477857ea3276a75207026fc6fbb9d06877315ab53ad490815c43e5a04fa9cf1b5ceadf662523ac0315056ed2b05842e00d407a318f3f638da63dc9993e@108.60.71.221:54270,enode://4dcdbc532d52641dbc47e887d498130d35022acd889e2773b60d9ee16e044b4f6fc9e9eb717a8edfdfb12c48f5cef641df0292ee3cda5d5c258836f2f1efbcf0@18.214.40.13:54338,enode://3e4ba348a24975da74da2c288e56db2b1374a5a86b24d957d678b1aae48e6acb29b5be6aaadf299a1e3b06f09bf8d6dd7eb89efe3a307c6193d81282afd7744c@5.189.178.189:30303,enode://89f5a106b7d9ad4dcd8c870d4b96aa0d1586abeed19d1626a96e01cd4a5e80e5f4832fe8e5822a1a59a543732d6b1814f58b984f59e69540eeebf6eb140c2120@84.65.92.148:59338,enode://b916a77c7f1df2e40ac0ac5aae34f1fbc648681025fed459b029d87dc0e97ef1a424669697dcc7862a54ef7a028dce0ce1d8468ff8d180a509d82d93b61a55d5@211.43.8.170:43764,enode://34e3eac0d9adebd6912f11832bbf1e604419dde287d907bd5b47dcc39ea3dd84d24f37c0fcfdb56fd161dc4219ba1b87f30aa2440e760c8167c1b8f9c2e4355b@97.115.119.38:46860,enode://7af2c04303803d8b1da606c4d04a49e7f9ab9c910421de7818c8e92e6629bea2cf697296ffbe00e8ddea535571702eae88ac541b1bd36dc1c2f1ecd80533b130@94.130.131.19:59466,enode://04b0fcf90b2fb5906da99bc307f6afd5311d595eae9cb90f8e17dbd25b3b6b60c1b895a80ac26a69acb8f2d1a2db86f07b078f2a667e6e766f3ca2f9743293ed@94.61.192.191:49388,enode://2b0f255323bbff1864e450fd953a88c29dbe8fbfca39b9a86f9923b46464a891760c69b1a977d8acdf269e0faaa806db94c5b87ebfd53424c1fe53cf357f8602@95.217.228.158:30303,enode://a2a2d8aeabc618db97c18e8d307554c55020031d52dc54a16b712b3e99ef8f21b4b7c87fbcdb7e0861c54a6680e088361127fc6fdc478014e86f5c970957ce37@89.145.167.146:30303,enode://1da22921001541845c604429f0cb93158afeab6bd9cd28ece244a6fd976b649093521df15fc8cb4464118d65739396952036c53b9a62314eb4a82ab94e2b5ff1@85.195.192.200:52720,enode://7e00a9d3d20bad77096fa214de8d157bd326c1298903b94bf39f0454ea4eba56f908aaca2d2f340c253598b016845194ae73912f35e30b32ef9f365bc3e54b00@62.171.160.170:39092"'
    else
      blkc="--goerli"
      cach=1024 # default
      maxp=50   # default
      node='--bootnodes "enode://a1e8102e7beb94207c8608d7e2615579cf34200c15e24fd797b178f42d05d2e9d9a89c73577d1f9f4070360df20a14014c242674f7731421b188f0bf4618480a@176.144.82.166:30303,enode://46add44b9f13965f7b9875ac6b85f016f341012d84f975377573800a863526f4da19ae2c620ec73d11591fa9510e992ecc03ad0751f53cc02f7c7ed6d55c7291@94.237.54.114:30313,enode://6010c16d5776036f0f96a526aa17e302b91b0c955b9edbbcde924d7e35e9b0646333b192dc1c18cf4c217ed4ba76632548a62daf6536d661637efa437c6d62d8@54.198.42.106:30303,enode://290955521ff90413b3d6a842e830f9a9ab468fd27058534ed410cef816beb57ec5d965f8fd74a5ac52c43c6277a6a47add4eff06b4f4bfdf1d597006b8b5b764@83.162.151.227:30303,enode://9d8eeb510d16515a9f8c3f542047d3cec3d4d19a2d2d3881fca1cabaabc99aad4b30e9339815f0fb57ee1b6c0bd54abf2033006145713c6f2b91ddb285a55757@78.46.136.255:30303,enode://a12c8f94d85b96c73fa9efdbbe1f7625907c3cdffac1f37eb50f995bce93f48a81200e8292e87660230c9390d712bf9c59deee4b69ef4c81017ac2f6562307e5@94.236.246.163:30303,enode://5eb99255b9e267d7bcaa95620218de6fdbcead7a61059796ec7bcd05451e0e9ab2511f7cfe5cd7e3e4d76b15b45367406a7dda2c720e9ea58161776df33704ee@104.163.209.53:30303,enode://2c3cc8872f6dabd0c80ae12a09d33ff957b2e5eae008166e36d64f16902b6d7adaf1303ea1e0c3d9305ca3716fae69c0eb59abf198b751b43faa01a008ff9d26@86.218.77.141:30303,enode://215813e4cbeea8c8a4241095cfa364b0e22996ef7aa44902a60a24569221376f2ec7980c7e8e7960bc395c2182c5d7e8762b1596863a8826c0b38785a11d3e38@49.12.106.203:30303,enode://ea35efec88e7c8f34a120b17b7358e4d2fcb6ca052bfd5a5c61ab5284a782224f32cb1c9e1768c8fe4b0e19c9fd610ff7b3b79f95cd9f7bf4b1a68eb39bf5909@5.252.226.187:30303,enode://27eb8bb162ee019410618b1b7430b3b3e13eb59e04fb148a01e0d7b9ca5b2808d9a3504623ad687c622ae2c7c63054b50abae5e9688822bdeefe6163525f611e@54.225.105.43:30303,enode://a61215641fb8714a373c80edbfa0ea8878243193f57c96eeb44d0bc019ef295abd4e044fd619bfc4c59731a73fb79afe84e9ab6da0c743ceb479cbb6d263fa91@3.11.147.67:30303,enode://f4471165eb8219564c1432d39ebee3ade2e70ebdbb1ea681260b2558eacfc7ca9c88b71f57571ddddf756790dc6db805a3645e43aa41ea52b258a61610201a76@89.142.71.16:30303,enode://10d35746b4fe0624efbaa08afb7ece9e30793484c3c682e069e921d74eb8eb7146fbd927d2ce278c384278c1bdeabb316e11c9881fa3c64638f1375360880591@47.90.59.177:30303,enode://6c8e48bcf1f2194b6625bcc066afe62593f0f78e1fc355698459733dcc562500396c7484e25d7cc80a796db186947436c9b3518c2f998dfe0d0c59284b08a3c2@144.76.236.199:40303,enode://a33926b9ace21b30ecba325d05fad62144cb2f0d825f7c184b669cb41b3802c95e9878fff8a9cbc79317a67cfde6a07eeb47d3fda1b779d0dbca02a45205ea23@203.192.211.202:30303"'
    fi
    golb="/var/lib/goethereum"
    echo $H|sudo -S mkdir -p $golb 2>/dev/null
    sudo apt install -y software-properties-common
    sudo add-apt-repository -y ppa:ethereum/ethereum
    sudo apt update -y
    sudo apt install -y geth
    sudo useradd --no-create-home --shell /bin/false $user
    sudo chown -R $user:$user $golb
    cat <<-EOF > $ethg.service
		[Unit]
		Description=eth1 geth service
		Wants=network-online.target
		After=network-online.target
		
		[Service]
		User=$user
		Group=$user
		Restart=always
		RestartSec=10
		ExecStart=/usr/bin/geth $blkc --http --datadir $golb --cache $cach --maxpeers $maxp $node
		ExecStopPost=/home/eth/eth2/t8mail GETHSTP \$SERVICE_RESULT \$EXIT_CODE \$EXIT_STATUS
		
		[Install]
		WantedBy=multi-user.target
		EOF
    sudo mv $ethg.service /etc/systemd/system/$ethg.service
    sudo chmod 644 /etc/systemd/system/$ethg.service
    t6 ge
    t6 ga
    t6 gj
  fi
fi
