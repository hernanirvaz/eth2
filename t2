#!/bin/bash

source /home/eth/eth2/t1

[[ -x $p0/eth2/t ]] || ln -s $p0/eth2/t6 $p0/eth2/t

if [[ $(pex 'ufw status'|grep -i inactive) ]]; then
  tex 'INIT FIREWALL'
  cex 'ufw default deny incoming'
  cex 'ufw default allow outgoing'
  uf3 22/tcp ossh
  [[ $cunm = $znm1 ]] && { uf6 2021/tcp nssh;uf1 53      192.168.8.0/24 dns; }
  [[ $cunm = $znm2 ]] && { uf6 2022/tcp nssh;uf1 123/udp 192.168.8.0/24 ntp; }
  [[ $cunm = $znm3 ]] && { uf6 2020/tcp nssh;uf1 53      192.168.8.0/24 dns; }
  [[ $cunm = $znm4 ]] && { uf6 2024/tcp nssh; }
  yex 'ufw enable'
  cex 'ufw status numbered'
  tex 'ROOTKIT SCANNER'
  cex 'apt install chkrootkit -y'
  cex 'chkrootkit -q'
else
  tex "FIREWALL $(pex 'ufw status'|grep -i status|tr -d :)"
fi

if [[ -f $s4/$n0.service || -f $s4/$n1.service || -f $s4/$n3.service ]]; then
  tex 'SERVER JA INSTALADO ANTES - LINUX UPDATE & SYSTEM CONFIGS SKIPPED'
else
  tex 'UPDATE LINUX'
  if [[ $(pex 'snap list') ]]; then
    cex 'snap remove lxd'
    cex 'snap remove core18'
    cex 'snap remove snapd'
    cex 'apt purge snapd'
  fi
  t4update linux

  tex 'UNATTENDED UPGRADES'
  cex 'apt install unattended-upgrades apt-listchanges landscape-common update-notifier-common python3-pip net-tools -y'
  cex 'dpkg-reconfigure -plow unattended-upgrades'

  tex 'LINUX SYSTEM CONFIGS'
  cex 'timedatectl set-ntp on'
  if [[ $cust = hrv ]]; then
    cex 'timedatectl set-timezone Europe/Lisbon'
    cc1 $c0 's%^ *#*NTP=.*$%NTP="192.168.8.28 ntp02.oal.ul.pt ntp04.oal.ul.pt time.google.com time.cloudflare.com time.facebook.com"%i' .conf
    cc1 $c1 's%^ *ENABLED=.*$%ENABLED=0%i'                                                                                       ;cc0 $c1
    cc1 $c2 "s%-wait-online *$%-wait-online $(iig $(idw))%i" .service                                                            ;cc0 $c2
  else
    cex 'timedatectl set-timezone Europe/Berlin'
    cc1 $c0 's%^ *#*NTP=.*$%NTP="time.google.com time.cloudflare.com time.facebook.com"%i' .conf
  fi
  cc0 $c0
  cc1 $c3 's%^ */* *Unattended-Upgrade::Mail .*$%Unattended-Upgrade::Mail "hernanilr@gmail.com";%i'                              ;cc0 $c3
  cc1 $c4 's%^ *printf%# printf%i'
  cc2 $c4 'printf "Welcome to %s %s (%s %s %s)\n" "$(uname -n)" "$DISTRIB_DESCRIPTION" "$(uname -o)" "$(uname -r)" "$(uname -m)"';cc0 $c4 755
  cc1 $c5 's%^ *printf%# printf%i'                                                                                               ;cc0 $c5 755
  cex "chmod -x $c6" # nao executa - nao acho ser necessario
  cex 'netplan apply'
  [[ $cunm = $znm2 ]] || cex "$w0 restart systemd-timesyncd"
fi

if [[ $cunm != $znm1 && $cunm != $vnm1 ]]; then
  tex 'GETH & OPEN ETHEREUM NAO DEVE SER INSTALADOS AQUI - DEVE FAZER REBOOT'
else
  user='eth1'
  if ! id $user &>$s3;then sudo useradd --no-create-home --shell /bin/false $user;fi
  if [[ -f $s4/$n0.service ]]; then
    tex 'GETH JA INSTALADO'
  else
    tex 'INSTALAR GETH'
    if [[ $B = mainnet ]]; then
      blkc=''
      maxp=50
    else
      blkc=' --goerli'
      maxp=50   # default
    fi
    cex 'add-apt-repository -y ppa:ethereum/ethereum'
    cex 'apt update -y'
    cex 'apt install -y software-properties-common ethereum'
    cex "mkdir -p $p9"
    cex "chown -R $user:$user $p9"
    cat <<-EOF > $n0.service
		[Unit]
		Description=eth1 geth service
		Wants=network-online.target
		After=network-online.target
		
		[Service]
		User=$user
		Group=$user
		Restart=always
		RestartSec=10
		ExecStart=$s0/geth$blkc --datadir $p9 --http --http.addr $zip1 --maxpeers $maxp --authrpc.addr $zip1 --authrpc.jwtsecret $p9/geth/jwt
		ExecStopPost=$p0/eth2/t8mail GETHSTP \$SERVICE_RESULT \$EXIT_CODE \$EXIT_STATUS
		
		[Install]
		WantedBy=multi-user.target
		EOF
    cex "mv $n0.service $s4/$n0.service"
    cex "chmod 644 $s4/$n0.service"
  fi
fi
