#!/bin/bash

source /home/eth/eth2/t1

function cc1 { local f=$(basename $1 $3);cp $1 $f.sav           ;sed  -e "$2" $1 > $f.n;sex "mv $f.n $1"; }                                                   # edit        file with sav
function cc2 { local f=$(basename $1 $3);cp $1 $f.sav;cp $1 $f.n;echo -e "$2"   >> $f.n;sex "mv $f.n $1"; }                                                   # add line to file with sav
function iig { local f=;until [[ $# -lt 1 ]];do f="$f --ignore=$1";shift;done;echo $f; }                                                                      # get list of ignore flags
function idw { ip link|grep DOWN|cut -d' ' -f2|tr -d :; }                                                                                                     # get down interfaces

[[ -x $p0/eth2/t ]] || ln -s $p0/eth2/t6 $p0/eth2/t                                                                                                           # link base commands
if [[ $(pex 'ufw status'|grep -i inactive) ]]; then
  swu 'INIT FIREWALL';sex 'ufw default deny incoming';sex 'ufw default allow outgoing'                                                                        # base ufw
  pde 22/tcp ossh;idi 192.168.8.0/24 224.0.0.1 multicast                                                                                                      # deny  ssh/multicasting
  [[ $cunm = $znm1 ]] && { ple 2021/tcp nssh; }                                                                                                               # limit ssh
  [[ $cunm = $znm2 ]] && { ple 2022/tcp nssh;pai 123/udp 192.168.8.0/24 ntp; }                                                                                # limit ssh;allow ntp
  [[ $cunm = $znm3 ]] && { ple 2023/tcp nssh; }                                                                                                               # limit ssh
  [[ $cunm = $znm4 ]] && { ple 2024/tcp nssh; }                                                                                                               # limit ssh
  sex 'ufw reload';yex 'ufw enable'                                                                                                                           # reload/enable
else
  cex 'ufw status numbered'                                                                                                                                   # show
fi
[[ -f $s4/$n0.service || -f $s4/$n1.service || -f $s4/$n3.service ]] && exit                                                                                  # ec/cl instalados -> exit
swu 'UPDATE LINUX'       ;t4update linux
swu 'ROOTKIT SCANNER'    ;sex 'apt install python3-pip net-tools lm-sensors chkrootkit -y';cex 'chkrootkit'
swu 'UNATTENDED UPGRADES';cex 'apt install unattended-upgrades apt-listchanges landscape-common update-notifier-common -y'
sudo dpkg-reconfigure -plow unattended-upgrades
swu 'LINUX CONFIGS'      ;sex 'timedatectl set-ntp on'
if [[ $cust = hrv ]]; then
  sex 'timedatectl set-timezone Europe/Lisbon'
  cc1 $c0 's%^ *#*NTP=.*$%NTP=192.168.8.28 ntp02.oal.ul.pt ntp04.oal.ul.pt time.google.com time.cloudflare.com time.facebook.com%i' .conf                   # my timesyncd servers
  cc1 $c1 's%^ *ENABLED=.*$%ENABLED=0%i'                                                         ;cmw $c1 644 root                                          # motd-news disable
  cc1 $c2 "s%-wait-online *$%-wait-online $(iig $(idw))%i" .service                              ;cmw $c2 644 root                                          # ignore down interfaces
else
  sex 'timedatectl set-timezone Europe/Berlin'
  cc1 $c0 's%^ *#*NTP=.*$%NTP=time.google.com time.cloudflare.com time.facebook.com%i' .conf                                                                # other timesyncd servers
fi;cmw $c0 644 root
cc1 $c3 's%^ */* *Unattended-Upgrade::Mail .*$%Unattended-Upgrade::Mail "hernanilr@gmail.com";%i';cmw $c3 644 root                                          # unattended-upgrades email
cc1 $c4 's%^ *printf%# printf%i'                                                                                                                            # header delete
cc2 $c4 'printf "Welcome to %s %s\\n" "$(uname -n)" "$DISTRIB_DESCRIPTION"'                      ;cmw $c4 755 root                                          # header add my motd
cc1 $c5 's%^ *printf%# printf%i'                                                                 ;cmw $c5 755 root                                          # help-text delete
cc1 $c6 's%timeout *=.*$%timeout=1%i'                                                            ;cmw $c6 755 root                                          # grub timeout
cc1 $c7 's%^ */var/log/syslog%# /var/log/syslog%'                                                                                                           # old logrotate delete
cc2 $c7 "$o5"                                                                                    ;cmw $c7 644 root                                          # new logrotate add
[[ -x $c8 ]] && sex "chmod -x $c8"                                                                                                                          # motd overlayroot unexecute
sex 'netplan apply';sex 'sudo update-grub';sex "$w0 restart $n7"

[[ $cunm = $znm1 || $cunm = $znm4 || $cunm = $vnm1 ]] || exit                                                                                               # ec here
swu 'INSTALAR GETH';sex 'add-apt-repository -y ppa:ethereum/ethereum';sex 'apt update -y';cex 'apt install -y software-properties-common ethereum'          # install execution client
sex "mkdir -p $p9";sau eth1;cmw $p9 755 $user                                                                                                               # create dir & user for ec
if [[ $B = mainnet ]]; then
  blkc=''
  maxp=50
else
  blkc=' --goerli'
  maxp=50   # default
fi
cat <<-EOF > $n0.service
[Unit]
Description=geth service
Wants=network-online.target
After=network-online.target

[Service]
User=$user
Group=$user
Restart=always
RestartSec=10
ExecStart=$s8/geth$blkc --datadir $p9 --http --http.addr $zip1 --maxpeers $maxp --authrpc.addr $zip1 --authrpc.jwtsecret $p9/geth/jwt
ExecStopPost=$p0/eth2/t8mail GETHSTP \$SERVICE_RESULT \$EXIT_CODE \$EXIT_STATUS

[Install]
WantedBy=multi-user.target
EOF
sex "mv $n0.service $s4/$n0.service";cmw $s4/$n0.service 644
