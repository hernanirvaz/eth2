#!/bin/bash

# utilities for commands/journal
function tex { echo -e "\n\e[5m${1^^}\e[25m\n"; }                                                                                                             # output text flash
function uex { echo -e "${1^^}"; }                                                                                                                            # output text upper
function nex { echo -e "$1"; }                                                                                                                                # output text normal
function cex { tex "$1";echo $H|sudo -S $1 2>$s3; }                                                                                                           # superuser-command (visible)
function pex {          echo $H|sudo -S $1 2>$s3; }                                                                                                           # superuser-command (pipe)
function sex {          echo $H|sudo -S $1 &>$s3; }                                                                                                           # superuser-command (silent)
function yex { tex "$1";echo $H|sudo -S $1 <<< y &>$s3; }                                                                                                     # superuser-command (yes & visible)
function sst { $w1 $1 2>$s3|grep "${2:-inactive\|failed}"                                   ; }                                                               # service status word test
function ss1 { $w1 $1 2>$s3|grep "${2:-Active:}"|sed "s%.*${2:-Active:} *\(${3:-.}*\).*%\1%"; }                                                               # service status word with 1 data extraction
function ss2 { $w1 $1 2>$s3|grep Active:|sed 's%.*Active: *\(.*\)%\1%;s% *since.*;%;%'      ; }                                                               # service status word with 2 data extraction
function sso { dts;echo "$1 $(printf '%6s' $(ss1 $2 Memory:)) $dt status: $(ss2 $2)"        ; }                                                               # service status output
function uf1 { cex "ufw allow from $2 to any port $1 comment $3"; }                                                                                           #        open  port from IP
function uf2 { cex "ufw allow $1 comment $2"; }                                                                                                               #        open  port from Anywhere
function uf3 { cex "ufw deny  $1 comment $2"; }                                                                                                               #        close port from Anywhere
function uf4 { cex "ufw delete allow from $2 to any port $1"; }                                                                                               # delete open  port from IP
function uf5 { cex "ufw delete deny $1"; }                                                                                                                    # delete close port from Anywhere
function uf6 { cex "ufw allow $1 comment $2";cex "ufw limit $1 comment $2"; }                                                                                 # limit  open  port from Anywhere
function cc0 { uex "chown ${2:-root:root} $1";uex "chmod ${3:-644} $1"; }
function cc1 { local f="$(basename $1 $3).save";sed  -e "$2" $1 > ~/$f;uex "mv $f $1"; }
function cc2 { local f="$(basename $1 $3).save";echo -e "$2"   >> ~/$f;uex "mv $f $1"; }
function idw { ip link show|grep -i down|cut -d' ' -f2|tr -d :; }
function iig { local m='';until [[ $# -lt 1 ]];do m="$m --ignore=$1";shift;done;echo $m; }

s0='/usr/local/bin'
s1='/var/log/syslog'
s2='/etc/prometheus'
s3='/dev/null'
s4='/etc/systemd/system'
s5='/var/run/reboot-required'
s6='/sys/bus/usb/devices/1-0\:1.0/authorized'
s7='/sys/devices/system/cpu/intel_pstate/no_turbo'
p0='/home/eth'
p1='/var/lib/lighthouse'
p2="$p0/beacon.log"
p3="$p0/bmedias.log"
p5="$p0/geth.log"
p6="$p0/barqivo.log"
p4="$p0/beacon.restart"
p7="$p1/beacon"
p8="$p1/validators"
p9='/var/lib/goethereum'
c0='/etc/systemd/timesyncd.conf'
c1='/etc/default/motd-news'
c2='/lib/systemd/system/systemd-networkd-wait-online.service'
c3='/etc/apt/apt.conf.d/50unattended-upgrades'
c4='/etc/update-motd.d/00-header'
c5='/etc/update-motd.d/10-help-text'
c6='/etc/update-motd.d/97-overlayroot'

w0='systemctl'
w1="$w0 status"
w2="$w0 stop"
w3="$w0 start"
w4="$w0 enable"
w5="$w0 disable"
n0='eth-geth'
n1='eth-beacon'
n3='eth-validator'
n4='prometheus'
n5='prometheus-node-exporter'
n6='grafana-server'
o0='plexmediaserver'
o1='transmission-daemon'
o2='named'
o3='geth\[\|lighthouse'
a0='0x82f6E45b47c5C03F8D52dDDa03B3F65897Cd5AB2'

meeu="$(whoami)"
cunm="$(uname -n)"
cust="$(uname -n|cut -c1-3)"
zip1='192.168.8.25'
zip2='192.168.8.28'
zip3='192.168.8.31'
zip4='192.168.8.34'
znm1='hrv-zotac1'
znm2='hrv-zotac2'
znm3='hrv-zotac3'
znm4='hrv-zotac4'
vip1='207.180.214.8'
vip2='173.249.42.190'
vip3='164.68.107.45'
vnm1='vmi471826.contaboserver.net'
vnm2='vmi506976.contaboserver.net'
vnm3='vmi469069.contaboserver.net'
bpid=$(ss1 $n1 PID: [0-9])

rblk=22238623
ratt=00019000
pmis=00010000
pmat=00018800
pmah=00004500
pdly=00000500
decp=1000000000
hors=24
rate=4000
bpri=20                                                                                                                                                       # min    configured peers
bprs=10                                                                                                                                                       # step   configured peers
bprf=80                                                                                                                                                       # max    configured peers

if [[ $cust = hrv ]];then cgth=$zip1;else cgth=$vip1;fi
[[ $rate -eq 0 ]] && rate=$(curl -sX GET 'https://pro-api.coinmarketcap.com/v1/cryptocurrency/quotes/latest?symbol=ETH&convert=EUR&CMC_PRO_API_KEY=3ae5f3df-bd71-489d-a9dd-b626995fba31'|sed 's%.*price.:\([0-9]*\.[0-9]*\).*%\1%')
