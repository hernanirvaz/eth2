#!/usr/bin/bash

cunm=$(hostname)
cust=${cunm:0:3}
function sht { [[ $cust = hrv ]]; }
function dnn { local s=$1;[[ ${s%%.*} =~ ^[a-zA-Z]+ ]] && ! sht && s="$s.fruga.pt";[[ ${s%%.*} == hrv-zotac1 ]] && s="admin@$s";printf %s $s; }
function dnp { local n=${1##*[!0-9]};local p=2020;[[ $1 =~ ^hrv-[a-z]{5}[0-9]$ ]] && p=$((p+n));printf %i $p; }
function dnz { local p=$2;[[ $p ]] || p=$(dnp $1);printf %i $p; }
function zsh { ssh -p $1 -i ~/.ssh/id_ed25519 $2 "$3"; }

function msh { echo -e "\n\e[5;32m${*^^}\e[0m";eval "$*"; }
function gsh { echo -e "\n\e[5;32m${*^^}\e[0m";eval "$*|grep $2"; }
function esl { local p=$(dnz $1 $2);local s=$(dnn $1);echo -e "\nzsh $s:$p     ";zsh $p $s; }
function erq { local q=${1:-changelogs.ubuntu.com};msh resolvectl query $q; }

if [[ $cunm = hrv-zotac2 ]];then
  cuip=$(hostname -I)
  cuip=${cuip%% *}
  mt1 () { id jellyfin &>>/dev/null; }
  mt2 () { id plex     &>>/dev/null; }
  mdi () { if mt1;then echo /media/mp4;elif mt2;then echo /var/lib/plexmediaserver/mp4;else echo /media/mp4;fi; }
  mus () { if mt1;then echo jellyfin  ;elif mt2;then echo plex                        ;else echo eth       ;fi; }
  rsy () { echo RSYNC $1 $2;rsync --ignore-existing --delete --numeric-ids -rv $1 $2; }
  smv () { local d=$(mdi);rsy $d/movie ztc3:; }
  stv () { local d=$(mdi);rsy $d/tv2   admin@ztc1:;rsy $d/tv admin@ztc1:; }
  slt () { local d=$(mdi);rsy $d/lust  ztc3:; }
  sal () { smv;sleep 10;stv;sleep 10;slt; }
  pmv () { rsy ztc3:~/movie ~; }
  ptv () { rsy admin@ztc1:~/tv2 ~;rsy admin@ztc1:~/tv ~; }
  plt () { rsy ztc3:~/lust ~; }
  pal () { pmv;ptv;plt; }
  fi0 () { local d=$(mdi);echo findls $1 $d;find $d -name "*.$1" -print; }
  fi1 () { local d=$(mdi);echo findrm $1 $d;find $d -name "*.$1" -exec sudo rm {} \;; }
  fll () { if [[ $1 ]];then fi0 $1;else fi0 txt;fi0 jpg;fi; }
  frm () { if [[ $1 ]];then fi1 $1;else fi1 txt;fi1 jpg;fi; }
  fom () { local d=$(mdi);local s=${1:-$(mus)};echo "ch[own|mod] $s $d";sudo chown $s:$s -R $d;sudo find $d -type d -exec chmod 755 {} \;;sudo find $d -type f -exec chmod 644 {} \;; }
  rll () { transmission-remote $cuip:9091 -l; }
  ri0 () { rll|sed -En 's%^ +([0-9]+) +100\% +.+Done +.+$%\1%p'; }
  ri1 () { local s=$1;shift;until [[ $# -lt 1 ]];do local s="$s,$1";shift;done;[[ $s ]] && printf $s; }
  rrm () { local e=$(ri1 $(ri0));[[ $e ]] || return;echo -e "remove $e\n";rll;transmission-remote $cuip:9091 -t $e --remove; }
  ft1 () { local d=${1:-$(mdi)/lust/ftv};find $d \( -iname "*.mp4" -or -iname "*.mkv" -or -iname "*.avi" \) -printf "%f\n"|grep -Po '\.[0-9]{2}\.\K[a-zA-Z]+'           |sort -u; }
  ft2 () { local d=${1:-$(mdi)/lust/ftv};find $d \( -iname "*.mp4" -or -iname "*.mkv" -or -iname "*.avi" \) -printf "%f\n"|grep -Po '\.[0-9]{2}\.\K[a-zA-Z]+\.[a-zA-Z]+'|sort -u; }
  fmv () { local d=${1:-$(mdi)/lust/ftv};find $d \( -iname "*.mp4" -or -iname "*.mkv" -or -iname "*.avi" \) -printf "%f\n"|sed -En "s%^(ftv.+)(\.[0-9]{2}\.[0-9]{2}\.[0-9]{2}\.)([a-z]+\.)([a-z]+\.)([a-z]+)(.*)([a-z0-9]{3})$%mv $d/\1\2\3\4\5\6\7 $d/\3\4\5\2\7%ip"; }
  ufz () { echo "$B"|gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 -c $1; }
  zfu () { echo "$B"|gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 -d $1; }
  hlp () {
    cat <<'EOF'
[ps][mv|tv|lt|al]  pull|sync movie|tv|lt|all
f[ll|rm|om]        list|remove|permission files
r[ll|rm]           list|remove done transmissions
f[tm][12v]         ftv names first|second|mv command
EOF
  }
  alias rcd='cd /var/lib/transmission-daemon/downloads;hlp'
  alias rp='t6 rpd'
  alias ra='t6 rea'
  alias ce='cns ceth'
  alias ct='tail -n10 cns.log'
  alias ca='cns ceth;tail -n10 cns.log'
elif [[ $cunm = hrv-intel5 || $cunm = hrv-intel6 ]];then
  alias aa='t6 ah'
elif [[ $cunm = hrv-zotac3 || $cunm = hrv-zotac4 ]];then
  alias aa='t6 ch'
fi

alias z1='esl hrv-zotac1'
alias zr='esl hrv-zotac1'
alias zl="zsh 2021 $(dnn hrv-zotac1) 'tail -n20 ~/rt-pfsense-wan-check.log'"

alias z2="esl hrv-zotac2"
alias z3="esl hrv-zotac3"
alias z4="esl hrv-zotac4"
alias z5="esl hrv-intel5"
alias z6="esl hrv-intel6"

if [[ $cust = hrv ]];then
  alias mr='echo meo:$V ;telnet 192.168.8.1'
else
  alias aa='t6 ah'
fi

alias st='speedtest --simple|grep -Ei "Ping|Download|Upload"|xargs'
alias nt='sudo iftop -nNPBF $(hostname -I|cut -d" " -f1)'
alias hh='t6 hs0'
alias tt='t6 hsh'
alias ky='ssh-keygen -f ~/.ssh/id_ed25519 -t ed25519 -C "$(whoami)@$(hostname)";cat ~/.ssh/id_ed25519.pub'
alias xx='exit'
alias rq='msh ip a;msh ip r;systemctl is-active --quiet systemd-networkd && msh networkctl status;msh resolvectl status;erq'
alias rd='msh resolvectl flush-caches;gsh dig AAAA hrv-zen.home.arpa;gsh dig AAAA hrv-lenovo.home.arpa;gsh dig AAAA hrv-zotac3.home.arpa;gsh dig AAAA hrv-zotac3.unknown.home.arpa'
