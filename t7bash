#!/bin/bash

source /home/eth/eth2/t1

function crg { curl -sH "Content-Type: application/json" -X GET "$1"; }
function crp { curl -sH "Content-Type: application/json" -X POST -d "[11766,11767,11770,11771,11772,11773,11774,11775,11776,11777,11778,11779,11780,11782,11783,11784,11786,11788,449113,449114,449115,449116,590905,590906,590907]" "$1"; }

h=$(crg $s31/beacon/headers/head|jq -r '.data.header.message.slot');e=$((h/32))
a=();for d in $(echo $(crp $s32/$e|jq -r $s33) $(crp $s32/$((e+1))|jq -r $s33)|jq -r '.slot+":"+.validator_index');do a[${d%:[0-9]*}]+=" ${d#[0-9]*:}";done
for s in $(echo ${!a[@]}|sort -n);do ((s<=h)) && unset a[$s];done
a[$(((e+2)*32))]=" "

longest_gap=0
gap_time_range=()
for s in $(echo ${!a[@]}|sort -n); do
    slot_str=$(date -d "@$((1606824023 + s * 12))" +%s)
    slot_end=$(date -d "@$((1606824023 + s * 12 + 12))" +%s)
    gap=$((slot_str - s34))
    if [[ -n "${a[$s]}" ]]; then
        nado=0
    else
        if (($s % 32 != 0)); then
            echo "Error: empty duty list not at epoch boundary" >&2
            exit 1
        fi
    fi
    if (($gap > $longest_gap)); then
        longest_gap=$gap
        gap_time_range=($(date -d "@$s34" +%s) $(date -d "@$((s34 + longest_gap))" +%s))
    fi
    s34=$(date -d "@$((1606824023 + s * 12 + 12))" +%s)
done
echo "$(date -d "@${gap_time_range[0]}" +%T) $longest_gap"
