#!/bin/bash

i="\n\e[5m"
f="\e[25m\n"

meeu="$(whoami)"
user="eth2"
ethg="eth-geth"
ethb="eth-beacon"
ethv="eth-validator"
ethp="prometheus"
ethn="prometheus-node-exporter"
ethf="grafana-server"

if [ -x ~/.cargo/bin/rustup ]; then
  echo -e "${i}UPDATE RUST${f}"
  source ~/.cargo/env
  rustup update
else
  echo -e "${i}INSTALAR DEPENDENCIAS RUST${f}"
  sudo apt install -y git gcc g++ make cmake pkg-config libssl-dev

  echo -e "${i}INSTALL RUST${f}"
  cd ~
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
fi
if [ -f ~/lighthouse/README.md ]; then
  cd ~/lighthouse
  git pull
else
  sudo rm -rf ~/lighthouse
  cd ~
  git clone https://github.com/sigp/lighthouse.git
fi 
echo -e "${i}VAI COMPILAR LIGHT${f}"
source ~/.cargo/env
cd ~/lighthouse
make
echo -e "${i}$(ntptime|grep -i ntp_|tr '[:lower:]' '[:upper:]')${f}"

if [ -x  ~/.cargo/bin/lighthouse ]; then

  if [ "$B" = "mainnet" ]; then
    blkc=""
  else
    blkc="--testnet $B"
  fi
  dtdi="/var/lib/lighthouse"
  becn="$dtdi/beacon"
  vldt="$dtdi/validators"

  echo -e "\n$H: CONFIGURE BEACON\n"
  t6 vpr
  t6 bpr
  cd ~
  sudo mkdir -p $becn
  if ! id $user &>/dev/null;then sudo useradd --no-create-home --shell /bin/false $user;fi
  sudo chown -R $user:$user $dtdi
  sudo cp ~/.cargo/bin/lighthouse /usr/local/bin
  cat <<-EOF > $ethb.service
  [Unit]
  Description=eth2 beacon service
  Wants=network-online.target
  After=network-online.target

  [Service]
  User=$user
  Group=$user
  Restart=always
  RestartSec=10
  ExecStart=/usr/local/bin/lighthouse $blkc --datadir $dtdi bn --staking --eth1-endpoint $E --metrics

  [Install]
  WantedBy=multi-user.target
EOF
  sudo mv $ethb.service /etc/systemd/system/$ethb.service
  sudo chmod 644 /etc/systemd/system/$ethb.service
  sudo ufw allow 9000 comment 'Lighthouse'
  sudo ufw reload
  t6 be
  t6 ba
  t6 bj

else

  echo -e "${i}NAO EXISTE BEACON COMPILADO PARA INSTALAR${f}"

fi
