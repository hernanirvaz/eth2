#!/bin/bash

source /home/eth/eth2/t1

# linux  NO GETH STOP | NO GETH START | NO REBOOT
# reboot    GETH STOP | NO GETH START |    REBOOT
# geth      GETH STOP |    GETH START | NO REBOOT
if [[ $1 = linux || $1 = reboot || $1 = geth ]]; then
  tex 'FULL-UPGRADE'
  [[ $1 = reboot || $1 = geth ]] && t6 gpr
  cex 'apt update -y'
  sudo apt full-upgrade -y && sudo apt dist-upgrade -y
  cex 'apt autoremove -y'
  cex 'apt autoclean'
  [[ $1 = geth   ]] && t6 gaj
  [[ $1 = reboot ]] && cex 'reboot'
fi

# eth2 update
[[ $1 != eth2 ]] && exit

if [[ $cunm = $znm1 || $cunm = $vnm1 ]]; then
  if [[ -x $p0/.cargo/bin/rustup ]]; then
    tex 'UPDATE RUST'
    resolvectl query static.rust-lang.org &>$s3
    #rustup toolchain install 1.52.1
    #rustup override set 1.52.1
    #rustup override unset
    rustup update stable
  fi
  if [[ -f $p0/lighthouse/README.md ]]; then
    cd $p0/lighthouse
    make clean
    cargo clean
  else
    cd $p0;cex "rm -rf $p0/lighthouse"
    resolvectl query github.com &>$s3
    git clone https://github.com/sigp/lighthouse.git
    cd $p0/lighthouse
  fi
  resolvectl query github.com &>$s3
  git fetch
  if [[ $(echo $2|egrep 'v[0-9]+\.[0-9]+\.[0-9]+') ]]; then
    v=$2
  else
    t=$(git rev-list --tags --max-count=1)
    v=$(git describe --tags $t)
  fi
  git checkout $v
  tex 'VAI COMPILAR LIGHT'
  make
  if [[ $? -eq 0 && -x $p0/.cargo/bin/lighthouse ]]; then
    if [[ $cunm = $znm1 ]]; then
      scp $p0/.cargo/bin/lighthouse ztc2:~
      scp $p0/.cargo/bin/lighthouse ztc3:~
      scp $p0/.cargo/bin/lighthouse ztc4:~
    fi
    if [[ -x $s0/lighthouse ]]; then
      sex "cp $s0/lighthouse $s0/lighthouse.sav"
      cex "cp $p0/.cargo/bin/lighthouse $s0"
    fi
  else
    tex 'NAO EXISTE LIGHT COMPILADO PARA INSTALAR'
  fi
else
  if [[ -x $p0/lighthouse ]]; then
    sex "cp $s0/lighthouse $s0/lighthouse.sav"
    cex "mv $p0/lighthouse $s0"
  else
    tex 'NAO EXISTE LIGHT COMPILADO PARA INSTALAR'
  fi
fi

if [[ -x $s0/lighthouse ]]; then
  sex "chmod 755 $s0/lighthouse*"
  sex "chown eth:eth $s0/lighthouse*"
  tex 'NOVO LIGHT INSTALADO - PODE/DEVE VERIFICAR'
fi
